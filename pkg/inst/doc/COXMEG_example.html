<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Liang He" />

<meta name="date" content="2019-08-22" />

<title>Cox mixed-effects models for genome-wide association analysis</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Cox mixed-effects models for genome-wide association analysis</h1>
<h4 class="author"><em>Liang He</em></h4>
<h4 class="date"><em>2019-08-22</em></h4>



<div id="overview" class="section level2">
<h2>Overview</h2>
<p>Time-to-event is one of the most important phenotypes in genetic epidemiology. The R-package, “coxmeg”, provides a set of utilities to fit a Cox mixed-effects model and to efficiently perform genome-wide association analysis of time-to-event phenotypes using a Cox mixed-effects model.</p>
</div>
<div id="installation" class="section level2">
<h2>Installation</h2>
<div id="most-recent-version" class="section level3">
<h3>Most-recent version</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;coxmeg&quot;</span>, <span class="dt">repos=</span><span class="st">&quot;http://R-Forge.R-project.org&quot;</span>)</code></pre></div>
</div>
</div>
<div id="functions" class="section level2">
<h2>Functions</h2>
<p>The current version provides four functions.</p>
<ul>
<li><code>coxmeg</code>: Fit a Cox mixed-effects model.</li>
<li><code>coxmeg_m</code>: Perform a GWAS using a genotype matrix.</li>
<li><code>coxmeg_plink</code>: Perform a GWAS using plink files.</li>
<li><code>fit_ppl</code>: Estimate HRs given a variance component.</li>
</ul>
</div>
<div id="fit-a-cox-mixed-effects-model-with-a-sparse-relatedness-matrix" class="section level2">
<h2>Fit a Cox mixed-effects model with a sparse relatedness matrix</h2>
<p>We illustrate how to use coxmeg to fit a Cox mixed-effects model with a sparse relatedness matrix. We first simulate a block-diagonal relatedness matrix for a cohort consisting of 200 families, each of which has five members.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(coxmeg)
<span class="kw">library</span>(MASS)
<span class="kw">library</span>(Matrix)
n_f &lt;-<span class="st"> </span><span class="dv">200</span>
mat_list &lt;-<span class="st"> </span><span class="kw">list</span>()
size &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">5</span>,n_f)
offd &lt;-<span class="st"> </span><span class="fl">0.5</span>
<span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_f)
{
  mat_list[[i]] &lt;-<span class="st"> </span><span class="kw">matrix</span>(offd,size[i],size[i])
  <span class="kw">diag</span>(mat_list[[i]]) &lt;-<span class="st"> </span><span class="dv">1</span>
}
sigma &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">bdiag</span>(mat_list))
sigma =<span class="st"> </span><span class="kw">as</span>(sigma,<span class="st">'dgCMatrix'</span>)</code></pre></div>
<p>We use ‘dgCMatrix’ to save memory. Next, we simulate random effects and time-to-event outcomes assuming a constant baseline hazard function. We assume that the variance component is 0.2. We also simulate a risk factor with log(HR)=0.1.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">n =<span class="st"> </span><span class="kw">nrow</span>(sigma)
tau_var &lt;-<span class="st"> </span><span class="fl">0.2</span>
x &lt;-<span class="st"> </span><span class="kw">mvrnorm</span>(<span class="dv">1</span>, <span class="kw">rep</span>(<span class="dv">0</span>,n), tau_var<span class="op">*</span>sigma)
pred =<span class="st"> </span><span class="kw">rnorm</span>(n,<span class="dv">0</span>,<span class="dv">1</span>)
myrates &lt;-<span class="st"> </span><span class="kw">exp</span>(x<span class="op">+</span><span class="fl">0.1</span><span class="op">*</span>pred<span class="op">-</span><span class="dv">1</span>)
y &lt;-<span class="st"> </span><span class="kw">rexp</span>(n, <span class="dt">rate =</span> myrates)
cen &lt;-<span class="st"> </span><span class="kw">rexp</span>(n, <span class="dt">rate =</span> <span class="fl">0.02</span> )
ycen &lt;-<span class="st"> </span><span class="kw">pmin</span>(y, cen)
outcome &lt;-<span class="st"> </span><span class="kw">cbind</span>(ycen,<span class="kw">as.numeric</span>(y <span class="op">&lt;=</span><span class="st"> </span>cen))
<span class="kw">head</span>(outcome)</code></pre></div>
<pre><code>##           ycen  
## [1,] 1.0667621 1
## [2,] 1.0210270 1
## [3,] 0.2167305 1
## [4,] 2.8324439 1
## [5,] 0.2406894 1
## [6,] 0.7880388 1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sigma[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]</code></pre></div>
<pre><code>## 5 x 5 sparse Matrix of class &quot;dgCMatrix&quot;
##                         
## [1,] 1.0 0.5 0.5 0.5 0.5
## [2,] 0.5 1.0 0.5 0.5 0.5
## [3,] 0.5 0.5 1.0 0.5 0.5
## [4,] 0.5 0.5 0.5 1.0 0.5
## [5,] 0.5 0.5 0.5 0.5 1.0</code></pre>
<p>We fit a Cox mixed-effects model using the <code>coxmeg</code> function. We set <code>dense=FALSE</code> to indicate that the relatedness matrix is sparse. However, the function will automatically treat it as dense if there are more than 50% non-zero elements in the matrix. We set <code>order=1</code> to use the first-order approximation of the inverse Hessian matrix in the optimization.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">re =<span class="st"> </span><span class="kw">coxmeg</span>(outcome,sigma,pred,<span class="dt">order=</span><span class="dv">1</span>,<span class="dt">dense=</span><span class="ot">FALSE</span>)</code></pre></div>
<pre><code>## Remove 0 subjects censored before the first failure.</code></pre>
<pre><code>## There is/are 1 predictors. The sample size included is 1000.</code></pre>
<pre><code>## The relatedness matrix is treated as sparse.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">re</code></pre></div>
<pre><code>## $beta
##          [,1]
## [1,] 0.124455
## 
## $HR
##          [,1]
## [1,] 1.132531
## 
## $sd_beta
## [1] 0.03633352
## 
## $p
##              [,1]
## [1,] 0.0006140104
## 
## $tau
## [1] 0.1718373
## 
## $iter
## [1] 18
## 
## $rank
## [1] 1000
## 
## $nsam
## [1] 1000
## 
## $int_ll
## [1] 11545.08</code></pre>
<p>In the above result, <code>tau</code> is the estimated variance component, and <code>int_ll</code> is -2*log(lik) of the integrated/marginal likelihood of tau.</p>
<p>It should be noted that when the relatedness matrix is symmetric positive definite (SPD), <code>coxmeg</code> will make use of the sparsity by setting <code>dense=FALSE</code> regardless of whether the relatedness matrix or its inverse is sparse. However, when the relatedness matrix is symmetric positive semidefinite (SPSD), <code>coxmeg</code> can make use of the sparsity only when its inverse is sparse. When the relatedness matrix is SPSD and its inverse is dense, setting <code>dense=FALSE</code> will result in worse performance. In such a case, it would be better to use <code>dense=TRUE</code> or to convert the relatedness matrix to SPD or block-diagonal if possible.</p>
<p>We compare the results with coxme, which are slightly different due to different approximation of the log-determinant used in the estimation of the variance component. Also, the integrated log-likelihoods cannot be compared directly because different approximation of log-determinant is used.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(coxme)
bls &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>)
<span class="cf">for</span>(i <span class="cf">in</span> (size[<span class="dv">1</span>]<span class="op">-</span><span class="dv">1</span>)<span class="op">:</span><span class="dv">1</span>)
{bls &lt;-<span class="st"> </span><span class="kw">c</span>(bls, <span class="kw">c</span>(<span class="kw">rep</span>(offd,i),<span class="dv">1</span>))}
tmat &lt;-<span class="st"> </span><span class="kw">bdsmatrix</span>(<span class="dt">blocksize=</span>size, <span class="dt">blocks=</span><span class="kw">rep</span>(bls,n_f),<span class="dt">dimnames=</span><span class="kw">list</span>(<span class="kw">as.character</span>(<span class="dv">1</span><span class="op">:</span>n),<span class="kw">as.character</span>(<span class="dv">1</span><span class="op">:</span>n)))
re_coxme =<span class="st"> </span><span class="kw">coxme</span>(<span class="kw">Surv</span>(outcome[,<span class="dv">1</span>],outcome[,<span class="dv">2</span>])<span class="op">~</span><span class="kw">as.matrix</span>(pred)<span class="op">+</span>(<span class="dv">1</span><span class="op">|</span><span class="kw">as.character</span>(<span class="dv">1</span><span class="op">:</span>n)), <span class="dt">varlist=</span><span class="kw">list</span>(tmat),<span class="dt">ties=</span><span class="st">'breslow'</span>)
re_coxme</code></pre></div>
<pre><code>## Cox mixed-effects model fit by maximum likelihood
## 
##   events, n = 947, 1000
##   Iterations= 12 54 
##                     NULL Integrated    Fitted
## Log-likelihood -5615.054  -5605.054 -5477.394
## 
##                    Chisq     df          p   AIC     BIC
## Integrated loglik  20.00   2.00 4.5383e-05 16.00    6.29
##  Penalized loglik 275.32 118.34 1.5543e-14 38.65 -535.67
## 
## Model:  Surv(outcome[, 1], outcome[, 2]) ~ as.matrix(pred) + (1 | as.character(1:n)) 
## Fixed coefficients
##                      coef exp(coef)   se(coef)    z       p
## as.matrix(pred) 0.1245657  1.132656 0.03637175 3.42 0.00062
## 
## Random effects
##  Group             Variable Std Dev   Variance 
##  as.character.1.n. Vmat.1   0.4166685 0.1736127</code></pre>
</div>
<div id="perform-gwas-of-an-age-at-onset-phenotype-with-a-sparse-relatedness-matrix" class="section level2">
<h2>Perform GWAS of an age-at-onset phenotype with a sparse relatedness matrix</h2>
<p>We illustrate how to perform a GWAS using the <code>coxmeg_plink</code> function. This function supports plink bed files. We provide example files in the package. The example plink files include 20 SNPs and 3000 subjects from 600 families. The following code performs a GWAS for all SNPs in the example bed files.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(coxmeg)
bed =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;example_null.bed&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;coxmeg&quot;</span>)
bed =<span class="st"> </span><span class="kw">substr</span>(bed,<span class="dv">1</span>,<span class="kw">nchar</span>(bed)<span class="op">-</span><span class="dv">4</span>)
pheno =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;ex_pheno.txt&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;coxmeg&quot;</span>)
cov =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;ex_cov.txt&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;coxmeg&quot;</span>)

## building a relatedness matrix
n_f &lt;-<span class="st"> </span><span class="dv">600</span>
mat_list &lt;-<span class="st"> </span><span class="kw">list</span>()
size &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">5</span>,n_f)
offd &lt;-<span class="st"> </span><span class="fl">0.5</span>
<span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_f)
{
  mat_list[[i]] &lt;-<span class="st"> </span><span class="kw">matrix</span>(offd,size[i],size[i])
  <span class="kw">diag</span>(mat_list[[i]]) &lt;-<span class="st"> </span><span class="dv">1</span>
}
sigma &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">bdiag</span>(mat_list))

re =<span class="st"> </span><span class="kw">coxmeg_plink</span>(pheno,sigma,bed,<span class="dt">cov_file=</span>cov,<span class="dt">detap=</span><span class="ot">TRUE</span>,<span class="dt">dense=</span><span class="ot">FALSE</span>,<span class="dt">verbose=</span><span class="ot">FALSE</span>)</code></pre></div>
<pre><code>## Excluding 0 SNP on non-autosomes
## Excluding 0 SNP (monomorphic: TRUE, MAF: 0.05, missing rate: 0)</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">re</code></pre></div>
<pre><code>## $summary
##     snp.id chromosome position allele      afreq   index         beta
## 1   null_0          1        1    d/D 0.30983333  null_0  0.015672101
## 2   null_1          1        2    d/D 0.23466667  null_1  0.019439150
## 3   null_2          1        3    D/d 0.14033333  null_2 -0.049845757
## 4   null_3          1        4    D/d 0.16183333  null_3  0.044130767
## 5   null_4          1        5    d/D 0.19933333  null_4  0.028473176
## 6   null_5          1        6    D/d 0.11800000  null_5 -0.114319159
## 7   null_6          1        7    d/D 0.09483333  null_6 -0.017981231
## 8   null_7          1        8    D/d 0.49683333  null_7 -0.004207897
## 9   null_8          1        9    d/D 0.31366667  null_8 -0.063741849
## 10  null_9          1       10    D/d 0.49183333  null_9 -0.008409562
## 11 null_10          1       11    d/D 0.34833333 null_10 -0.013581479
## 12 null_11          1       12    D/d 0.25100000 null_11  0.037508301
## 13 null_12          1       13    d/D 0.17500000 null_12 -0.017215848
## 14 null_13          1       14    D/d 0.06333333 null_13 -0.068207724
## 15 null_14          1       15    D/d 0.20833333 null_14 -0.013965386
## 16 null_15          1       16    d/D 0.17050000 null_15  0.002172773
## 17 null_16          1       17    D/d 0.33550000 null_16  0.004762350
## 18 null_17          1       18    d/D 0.26633333 null_17  0.001786995
## 19 null_18          1       19    D/d 0.09433333 null_18 -0.016052310
## 20 null_19          1       20    d/D 0.11650000 null_19 -0.022398126
##           HR    sd_beta           p
## 1  1.0157956 0.02938524 0.593803537
## 2  1.0196293 0.03222054 0.546298835
## 3  0.9513762 0.03860368 0.196628160
## 4  1.0451190 0.03701019 0.233106387
## 5  1.0288824 0.03432500 0.406811816
## 6  0.8919732 0.04234095 0.006934636
## 7  0.9821795 0.04655562 0.699325464
## 8  0.9958009 0.02717805 0.876957699
## 9  0.9382472 0.02958441 0.031195036
## 10 0.9916257 0.02730686 0.758108827
## 11 0.9865103 0.02859980 0.634872392
## 12 1.0382206 0.03113254 0.228282858
## 13 0.9829315 0.03628637 0.635183349
## 14 0.9340664 0.05698849 0.231357835
## 15 0.9861317 0.03431600 0.684034201
## 16 1.0021751 0.03685682 0.952990554
## 17 1.0047737 0.02859957 0.867749134
## 18 1.0017886 0.03098518 0.954009439
## 19 0.9840758 0.04731969 0.734435643
## 20 0.9778508 0.04231689 0.596600710
## 
## $tau
## [1] 0.04028041
## 
## $rank
## [1] 3000
## 
## $nsam
## [1] 3000</code></pre>
<p>The above code first retrieves the full path of the files. If the full path is not given, the function will search the current working directory. The file name for the bed file should not include the suffix (.bed). The phenotype and covariate files have the same format as used in plink, and the IDs must be consistent with the bed files. Specifically, the phenotype file should include four columns including family ID, individual ID, time, and status. The covariate file always starts with two columns, family ID and individual ID. Missing values in the phenotype and covariate files are denoted by -9 and NA, respectively. In the current version, the <code>coxmeg_plink</code> function does not impute genotypes itself, and only SNPs without missing values will be analyzed, so it will be better to use imputed genotype data.</p>
<p>The <code>coxmeg_plink</code> function fist estimates the variance component with only the covariates, and then uses it to analyze each SNP after filtering. These two steps can be done separately as follows. The first command without bed only esitmates the variance component tau, and the second command uses the estimated tau to analyze the SNPs. The <code>coxmeg_plink</code> function will write a temporary .gds file for the SNPs in the same folder of the bed files. The temporary file is removed after the analysis is done.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">re =<span class="st"> </span><span class="kw">coxmeg_plink</span>(pheno,sigma,<span class="dt">cov_file=</span>cov,<span class="dt">detap=</span><span class="ot">TRUE</span>,<span class="dt">dense=</span><span class="ot">FALSE</span>,<span class="dt">verbose=</span><span class="ot">FALSE</span>)
re</code></pre></div>
<pre><code>## $tau
## [1] 0.04028041
## 
## $iter
## [1] 15
## 
## $rank
## [1] 3000
## 
## $nsam
## [1] 3000</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">re =<span class="st"> </span><span class="kw">coxmeg_plink</span>(pheno,sigma,bed,<span class="dt">tau=</span>re<span class="op">$</span>tau,<span class="dt">cov_file=</span>cov,<span class="dt">detap=</span><span class="ot">TRUE</span>,<span class="dt">dense=</span><span class="ot">FALSE</span>,<span class="dt">verbose=</span><span class="ot">FALSE</span>)</code></pre></div>
<pre><code>## Excluding 0 SNP on non-autosomes
## Excluding 0 SNP (monomorphic: TRUE, MAF: 0.05, missing rate: 0)</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">re</code></pre></div>
<pre><code>## $summary
##     snp.id chromosome position allele      afreq   index         beta
## 1   null_0          1        1    d/D 0.30983333  null_0  0.015672101
## 2   null_1          1        2    d/D 0.23466667  null_1  0.019439150
## 3   null_2          1        3    D/d 0.14033333  null_2 -0.049845757
## 4   null_3          1        4    D/d 0.16183333  null_3  0.044130767
## 5   null_4          1        5    d/D 0.19933333  null_4  0.028473176
## 6   null_5          1        6    D/d 0.11800000  null_5 -0.114319159
## 7   null_6          1        7    d/D 0.09483333  null_6 -0.017981231
## 8   null_7          1        8    D/d 0.49683333  null_7 -0.004207897
## 9   null_8          1        9    d/D 0.31366667  null_8 -0.063741849
## 10  null_9          1       10    D/d 0.49183333  null_9 -0.008409562
## 11 null_10          1       11    d/D 0.34833333 null_10 -0.013581479
## 12 null_11          1       12    D/d 0.25100000 null_11  0.037508301
## 13 null_12          1       13    d/D 0.17500000 null_12 -0.017215848
## 14 null_13          1       14    D/d 0.06333333 null_13 -0.068207724
## 15 null_14          1       15    D/d 0.20833333 null_14 -0.013965386
## 16 null_15          1       16    d/D 0.17050000 null_15  0.002172773
## 17 null_16          1       17    D/d 0.33550000 null_16  0.004762350
## 18 null_17          1       18    d/D 0.26633333 null_17  0.001786995
## 19 null_18          1       19    D/d 0.09433333 null_18 -0.016052310
## 20 null_19          1       20    d/D 0.11650000 null_19 -0.022398126
##           HR    sd_beta           p
## 1  1.0157956 0.02938524 0.593803537
## 2  1.0196293 0.03222054 0.546298835
## 3  0.9513762 0.03860368 0.196628160
## 4  1.0451190 0.03701019 0.233106387
## 5  1.0288824 0.03432500 0.406811816
## 6  0.8919732 0.04234095 0.006934636
## 7  0.9821795 0.04655562 0.699325464
## 8  0.9958009 0.02717805 0.876957699
## 9  0.9382472 0.02958441 0.031195036
## 10 0.9916257 0.02730686 0.758108827
## 11 0.9865103 0.02859980 0.634872392
## 12 1.0382206 0.03113254 0.228282858
## 13 0.9829315 0.03628637 0.635183349
## 14 0.9340664 0.05698849 0.231357835
## 15 0.9861317 0.03431600 0.684034201
## 16 1.0021751 0.03685682 0.952990554
## 17 1.0047737 0.02859957 0.867749134
## 18 1.0017886 0.03098518 0.954009439
## 19 0.9840758 0.04731969 0.734435643
## 20 0.9778508 0.04231689 0.596600710
## 
## $tau
## [1] 0.04028041
## 
## $rank
## [1] 3000
## 
## $nsam
## [1] 3000</code></pre>
<p>When the genotypes of a group of SNPs are stored in a matrix, the function <code>coxmeg_m</code> can be used to perform GWAS for each of the SNPs. Similarly, <code>coxmeg_m</code> first estimates the variance component without the SNPs. In the following example, we simulate 10 independent SNPs, and use <code>coxmeg_m</code> to perform association analysis.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">geno =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rbinom</span>(<span class="kw">nrow</span>(sigma)<span class="op">*</span><span class="dv">10</span>,<span class="dv">2</span>,<span class="kw">runif</span>(<span class="kw">nrow</span>(sigma)<span class="op">*</span><span class="dv">10</span>,<span class="fl">0.05</span>,<span class="fl">0.5</span>)),<span class="kw">nrow</span>(sigma),<span class="dv">10</span>)
pheno_m =<span class="st"> </span><span class="kw">read.table</span>(pheno)
re =<span class="st"> </span><span class="kw">coxmeg_m</span>(geno,pheno_m[,<span class="dv">3</span><span class="op">:</span><span class="dv">4</span>],sigma,<span class="dt">detap=</span><span class="ot">TRUE</span>,<span class="dt">dense=</span><span class="ot">FALSE</span>,<span class="dt">verbose=</span><span class="ot">FALSE</span>)
re</code></pre></div>
<pre><code>## $summary
##            beta       HR    sd_beta         p
## 1  0.0154323276 1.015552 0.02941713 0.5998589
## 2  0.0140376495 1.014137 0.02944153 0.6335063
## 3  0.0145462290 1.014653 0.02941534 0.6209448
## 4  0.0009787399 1.000979 0.02936493 0.9734112
## 5  0.0303891121 1.030856 0.02961254 0.3047858
## 6  0.0244686790 1.024770 0.02976213 0.4109964
## 7  0.0128922705 1.012976 0.02942625 0.6612982
## 8  0.0130296976 1.013115 0.02925087 0.6559971
## 9  0.0594776665 1.061282 0.02891376 0.0396794
## 10 0.0201817041 1.020387 0.02979025 0.4981141
## 
## $tau
## [1] 0.04052206
## 
## $rank
## [1] 3000
## 
## $nsam
## [1] 3000</code></pre>
</div>
<div id="handle-positive-semidefinite-relatedness-matrices" class="section level2">
<h2>Handle positive semidefinite relatedness matrices</h2>
<p>We now assume that the first two subjects in the sample are monozygotic twins, and thus the relatedness matrix becomes positive semidefinite. To handle this, use <code>spd=FALSE</code> as follows.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sigma[<span class="dv">2</span>,<span class="dv">1</span>] =<span class="st"> </span>sigma[<span class="dv">1</span>,<span class="dv">2</span>] =<span class="st"> </span><span class="dv">1</span>
re =<span class="st"> </span><span class="kw">coxmeg_plink</span>(pheno,sigma,<span class="dt">cov_file=</span>cov,<span class="dt">detap=</span><span class="ot">TRUE</span>,<span class="dt">dense=</span><span class="ot">FALSE</span>,<span class="dt">verbose=</span><span class="ot">FALSE</span>,<span class="dt">spd=</span><span class="ot">FALSE</span>)</code></pre></div>
<pre><code>## Warning in chol.default(x, pivot = TRUE): the matrix is either rank-
## deficient or indefinite</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">re</code></pre></div>
<pre><code>## $tau
## [1] 0.04038302
## 
## $iter
## [1] 15
## 
## $rank
## [1] 2999
## 
## $nsam
## [1] 3000</code></pre>
<p>The warning indicates that the matrix is not full rank. The rank is less than the sample size.</p>
</div>
<div id="perform-gwas-of-an-age-at-onset-phenotype-with-a-dense-relatedness-matrix" class="section level2">
<h2>Perform GWAS of an age-at-onset phenotype with a dense relatedness matrix</h2>
<p>When the relatedness matrix is dense and large (&gt;5000), it will be more efficient to specify <code>dense=TRUE</code>, and use preconditioned conjugate gradiant <code>solver=2</code> and stochastic lanczos quadrature <code>detap=TRUE</code> in the optimization. These can be specified as follows.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">re =<span class="st"> </span><span class="kw">coxmeg_plink</span>(pheno,sigma,bed,<span class="dt">cov_file=</span>cov,<span class="dt">detap=</span><span class="ot">TRUE</span>,<span class="dt">dense=</span><span class="ot">TRUE</span>,<span class="dt">verbose=</span><span class="ot">FALSE</span>,<span class="dt">spd=</span><span class="ot">FALSE</span>,<span class="dt">solver=</span><span class="dv">2</span>)</code></pre></div>
<pre><code>## Warning in chol.default(x, pivot = TRUE): the matrix is either rank-
## deficient or indefinite</code></pre>
<pre><code>## Excluding 0 SNP on non-autosomes
## Excluding 0 SNP (monomorphic: TRUE, MAF: 0.05, missing rate: 0)</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">re</code></pre></div>
<pre><code>## $summary
##     snp.id chromosome position allele      afreq   index         beta
## 1   null_0          1        1    d/D 0.30983333  null_0  0.015917104
## 2   null_1          1        2    d/D 0.23466667  null_1  0.019217578
## 3   null_2          1        3    D/d 0.14033333  null_2 -0.051078896
## 4   null_3          1        4    D/d 0.16183333  null_3  0.043842380
## 5   null_4          1        5    d/D 0.19933333  null_4  0.028557926
## 6   null_5          1        6    D/d 0.11800000  null_5 -0.114899105
## 7   null_6          1        7    d/D 0.09483333  null_6 -0.017666154
## 8   null_7          1        8    D/d 0.49683333  null_7 -0.004401558
## 9   null_8          1        9    d/D 0.31366667  null_8 -0.063750281
## 10  null_9          1       10    D/d 0.49183333  null_9 -0.008635397
## 11 null_10          1       11    d/D 0.34833333 null_10 -0.013584165
## 12 null_11          1       12    D/d 0.25100000 null_11  0.037890633
## 13 null_12          1       13    d/D 0.17500000 null_12 -0.017118044
## 14 null_13          1       14    D/d 0.06333333 null_13 -0.068393064
## 15 null_14          1       15    D/d 0.20833333 null_14 -0.014453887
## 16 null_15          1       16    d/D 0.17050000 null_15  0.001915781
## 17 null_16          1       17    D/d 0.33550000 null_16  0.004518669
## 18 null_17          1       18    d/D 0.26633333 null_17  0.001518337
## 19 null_18          1       19    D/d 0.09433333 null_18 -0.016107261
## 20 null_19          1       20    d/D 0.11650000 null_19 -0.023314748
##           HR    sd_beta           p
## 1  1.0160445 0.02950432 0.589553046
## 2  1.0194034 0.03236038 0.552604840
## 3  0.9502037 0.03874538 0.187395846
## 4  1.0448177 0.03717863 0.238304233
## 5  1.0289696 0.03447429 0.407453458
## 6  0.8914561 0.04255197 0.006929645
## 7  0.9824890 0.04674494 0.705485182
## 8  0.9956081 0.02731479 0.871981627
## 9  0.9382393 0.02967764 0.031706487
## 10 0.9914018 0.02741452 0.752766532
## 11 0.9865077 0.02871432 0.636156209
## 12 1.0386176 0.03125629 0.225414315
## 13 0.9830276 0.03643693 0.638498422
## 14 0.9338933 0.05720541 0.231864469
## 15 0.9856501 0.03447631 0.675039900
## 16 1.0019176 0.03700791 0.958714516
## 17 1.0045289 0.02873589 0.875049192
## 18 1.0015195 0.03112789 0.961096708
## 19 0.9840218 0.04747760 0.734413719
## 20 0.9769549 0.04251763 0.583448308
## 
## $tau
## [1] 0.04580659
## 
## $rank
## [1] 2999
## 
## $nsam
## [1] 3000</code></pre>
<p>The above command estimates HRs and reports p-values. Instead, a score test, which is computationally much more efficient, can be used by specifying <code>score=TRUE</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">re =<span class="st"> </span><span class="kw">coxmeg_plink</span>(pheno,sigma,bed,<span class="dt">tau=</span>re<span class="op">$</span>tau,<span class="dt">cov_file=</span>cov,<span class="dt">detap=</span><span class="ot">TRUE</span>,<span class="dt">dense=</span><span class="ot">TRUE</span>,<span class="dt">verbose=</span><span class="ot">FALSE</span>,<span class="dt">spd=</span><span class="ot">FALSE</span>,<span class="dt">solver=</span><span class="dv">2</span>,<span class="dt">score=</span><span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## Warning in chol.default(x, pivot = TRUE): the matrix is either rank-
## deficient or indefinite</code></pre>
<pre><code>## Excluding 0 SNP on non-autosomes
## Excluding 0 SNP (monomorphic: TRUE, MAF: 0.05, missing rate: 0)</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">re</code></pre></div>
<pre><code>## $summary
##     snp.id chromosome position allele      afreq   index  score_test
## 1   null_0          1        1    d/D 0.30983333  null_0 0.291109511
## 2   null_1          1        2    d/D 0.23466667  null_1 0.352677929
## 3   null_2          1        3    D/d 0.14033333  null_2 1.736857532
## 4   null_3          1        4    D/d 0.16183333  null_3 1.391144626
## 5   null_4          1        5    d/D 0.19933333  null_4 0.686610524
## 6   null_5          1        6    D/d 0.11800000  null_5 7.311453091
## 7   null_6          1        7    d/D 0.09483333  null_6 0.142908566
## 8   null_7          1        8    D/d 0.49683333  null_7 0.026002765
## 9   null_8          1        9    d/D 0.31366667  null_8 4.608114699
## 10  null_9          1       10    D/d 0.49183333  null_9 0.099265955
## 11 null_10          1       11    d/D 0.34833333 null_10 0.223793250
## 12 null_11          1       12    D/d 0.25100000 null_11 1.469699673
## 13 null_12          1       13    d/D 0.17500000 null_12 0.220764280
## 14 null_13          1       14    D/d 0.06333333 null_13 1.429639651
## 15 null_14          1       15    D/d 0.20833333 null_14 0.175779024
## 16 null_15          1       16    d/D 0.17050000 null_15 0.002681977
## 17 null_16          1       17    D/d 0.33550000 null_16 0.024755668
## 18 null_17          1       18    d/D 0.26633333 null_17 0.002380450
## 19 null_18          1       19    D/d 0.09433333 null_18 0.114959412
## 20 null_19          1       20    d/D 0.11650000 null_19 0.300943613
##             p
## 1  0.58951041
## 2  0.55260112
## 3  0.18753749
## 4  0.23821189
## 5  0.40731967
## 6  0.00685165
## 7  0.70540646
## 8  0.87189356
## 9  0.03182100
## 10 0.75271230
## 11 0.63616473
## 12 0.22539308
## 13 0.63845819
## 14 0.23182326
## 15 0.67502606
## 16 0.95869777
## 17 0.87497742
## 18 0.96108676
## 19 0.73456705
## 20 0.58329146
## 
## $tau
## [1] 0.04580659
## 
## $rank
## [1] 2999
## 
## $nsam
## [1] 3000</code></pre>
<p>In the results, <code>score_test</code> is the score test statistics, which follow a chi-sq distribution.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
